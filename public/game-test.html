<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darajat Game - Complete Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .content { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        .section h2 { color: #667eea; margin-bottom: 20px; font-size: 1.5em; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry { margin-bottom: 8px; padding: 5px; border-left: 3px solid transparent; }
        .log-entry.success { border-left-color: #4caf50; color: #4caf50; }
        .log-entry.error { border-left-color: #f44336; color: #f44336; }
        .log-entry.info { border-left-color: #2196f3; color: #2196f3; }
        .hidden { display: none; }
        .question-container {
            background: #fff3e0;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .question-container h3 { color: #e65100; margin-bottom: 15px; }
        .option-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }
        .option-btn:hover { border-color: #667eea; background: #f1f8f4; }
        .option-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 20px;
        }
        .players-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .player-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge.host { background: #4caf50; color: white; }
        .badge.ready { background: #2196f3; color: white; }
        .full-width { grid-column: 1 / -1; }
        .instructions {
            background: #fff9c4;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #fbc02d;
        }
        .instructions h3 { color: #f57f17; margin-bottom: 15px; }
        .instructions ol { margin-left: 20px; }
        .instructions li { margin: 10px 0; color: #555; }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Darajat Game - Complete Test</h1>
            <p>Test Complete Game Flow: Login ‚Üí Create/Join ‚Üí Lobby ‚Üí Start ‚Üí Answer ‚Üí Summary</p>
        </div>
        <div class="content">
            <!-- Instructions -->
            <div class="instructions full-width">
                <h3>üìã Complete Testing Guide (Login se Finish Game tak):</h3>
                <ol>
                    <li><strong>Step 1 - Login:</strong> Enter email & password, click "Login"</li>
                    <li><strong>Step 2 - Socket Connect:</strong> Auto-connects after login</li>
                    <li><strong>Step 3 - Create Room (Host):</strong> Set questions, players, categories ‚Üí Click "Create Room"</li>
                    <li><strong>Step 4 - Join Room (Players):</strong> Enter room code ‚Üí Click "Join Room"</li>
                    <li><strong>Step 5 - Lobby:</strong> See all players, click "Mark Ready" (all players must be ready)</li>
                    <li><strong>Step 6 - Start Game (Host Only):</strong> Click "Start Game" button</li>
                    <li><strong>Step 7 - Answer Questions:</strong> Select option or wait for timer (auto-skip)</li>
                    <li><strong>Step 8 - Game Summary:</strong> View correct/wrong/skipped answers, accuracy, rank</li>
                    <li><strong>Step 9 - Leaderboard:</strong> Click "View Leaderboard" to see all players' scores</li>
                </ol>
                <div class="code-block">
                    <strong>Server:</strong> http://localhost:5000<br>
                    <strong>Socket Path:</strong> /ws/socket.io<br>
                    <strong>Test Pages:</strong> player1.html (Host), player2.html, player3.html (Players)
                </div>
            </div>

            <!-- Login Section -->
            <div class="section">
                <h2>üîê Step 1: Login</h2>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" value="test@example.com" placeholder="Enter email">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" value="password123" placeholder="Enter password">
                </div>
                <button onclick="login()">Login</button>
                <div id="loginStatus"></div>
            </div>

            <!-- Socket Status -->
            <div class="section">
                <h2>üîå Socket Status</h2>
                <div id="socketStatus" class="status info">Not Connected</div>
                <button onclick="connectSocket()" id="connectBtn" disabled>Connect Socket</button>
            </div>

            <!-- Create Room Section -->
            <div class="section hidden" id="roomSection">
                <h2>üè† Create Room (Host)</h2>
                <div class="form-group">
                    <label>Room Code:</label>
                    <input type="text" id="roomCode" placeholder="Auto-generated" readonly>
                </div>
                <div class="form-group">
                    <label>Number of Questions:</label>
                    <input type="number" id="numberOfQuestions" value="5" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Max Players:</label>
                    <input type="number" id="maximumPlayers" value="7" min="2" max="10">
                </div>
                <div class="form-group">
                    <label>Categories:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <input type="checkbox" id="catQuran" checked>
                                <span>Quran</span>
                            </label>
                            <select id="diffQuran" style="width: 100%; padding: 8px; border-radius: 5px;">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <input type="checkbox" id="catHadith">
                                <span>Hadith</span>
                            </label>
                            <select id="diffHadith" style="width: 100%; padding: 8px; border-radius: 5px;">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <input type="checkbox" id="catHistory">
                                <span>History</span>
                            </label>
                            <select id="diffHistory" style="width: 100%; padding: 8px; border-radius: 5px;">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <input type="checkbox" id="catFiqh">
                                <span>Fiqh</span>
                            </label>
                            <select id="diffFiqh" style="width: 100%; padding: 8px; border-radius: 5px;">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <input type="checkbox" id="catSeerah">
                                <span>Seerah</span>
                            </label>
                            <select id="diffSeerah" style="width: 100%; padding: 8px; border-radius: 5px;">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button onclick="createRoom()">Create Room</button>
                <div id="createRoomStatus"></div>
            </div>

            <!-- Join Room Section -->
            <div class="section hidden" id="joinSection">
                <h2>üö™ Join Room</h2>
                <div class="form-group">
                    <label>Room Code:</label>
                    <input type="text" id="joinRoomCode" placeholder="Enter room code">
                </div>
                <button onclick="joinRoom()">Join Room</button>
                <div id="joinRoomStatus"></div>
            </div>

            <!-- Lobby Section -->
            <div class="section hidden" id="lobbySection">
                <h2>üë• Lobby</h2>
                <div id="roomInfo"></div>
                <div id="playersList" class="players-list"></div>
                <button onclick="toggleReady()" id="readyBtn">Mark Ready</button>
                <button onclick="startGame()" id="startBtn" style="background: #f44336; margin-top: 10px;" disabled>Start Game (Host Only)</button>
                <div id="lobbyStatus"></div>
            </div>

            <!-- Game Section -->
            <div class="section hidden full-width" id="gameSection">
                <h2>üéÆ Game In Progress</h2>
                <div class="timer" id="timer">--</div>
                <div id="questionContainer" class="question-container"></div>
                <div id="gameStatus"></div>
            </div>

            <!-- Summary Section -->
            <div class="section hidden full-width" id="summarySection">
                <h2>üìä Game Summary</h2>
                <div id="summaryContent"></div>
                <button onclick="getLeaderboard()">View Leaderboard</button>
                <div id="leaderboardContent"></div>
            </div>

            <!-- API Testing Section -->
            <div class="section full-width">
                <h2>üß™ API Testing</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button onclick="testGetLobby()" style="background: #4caf50;">Get Lobby</button>
                    <button onclick="testGetQuestions()" style="background: #4caf50;">Get Questions</button>
                    <button onclick="testGetSummary()" style="background: #4caf50;">Get Summary</button>
                    <button onclick="testGetLeaderboard()" style="background: #4caf50;">Get Leaderboard</button>
                    <button onclick="testGetMyGames()" style="background: #4caf50;">Get My Games</button>
                    <button onclick="testGetRoom()" style="background: #4caf50;">Get Room</button>
                </div>
                <div id="apiResponse" class="log-container" style="max-height: 200px; margin-top: 15px;"></div>
            </div>

            <!-- Logs Section -->
            <div class="section full-width">
                <h2>üìù Event Logs</h2>
                <button onclick="clearLogs()" style="background: #f44336; margin-bottom: 15px;">Clear Logs</button>
                <div class="log-container" id="logs"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        const SOCKET_URL = 'http://localhost:5000';
        
        let token = '';
        let socket = null;
        let currentUser = null;
        let currentRoom = null;
        let currentQuestion = null;
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let timeLeft = 0;
        let isHost = false;

        function log(message, type = 'info') {
            const logsContainer = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('Logs cleared', 'info');
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // Login
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                log('Attempting login...', 'info');
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (data.status === 1 && data.data && data.data.token) {
                    token = data.data.token;
                    currentUser = data.data;
                    log('‚úÖ Login successful!', 'success');
                    showStatus('loginStatus', 'Login successful!', 'success');
                    document.getElementById('connectBtn').disabled = false;
                    setTimeout(() => connectSocket(), 500);
                } else {
                    log('‚ùå Login failed: ' + (data.message || 'Invalid credentials'), 'error');
                    showStatus('loginStatus', data.message || 'Login failed', 'error');
                }
            } catch (error) {
                log('‚ùå Login error: ' + error.message, 'error');
                showStatus('loginStatus', 'Login error: ' + error.message, 'error');
            }
        }

        // Connect Socket
        function connectSocket() {
            if (!token) {
                log('‚ùå Please login first', 'error');
                return;
            }

            if (socket && socket.connected) {
                log('‚ö†Ô∏è Socket already connected', 'warning');
                return;
            }

            log('üîå Connecting to socket...', 'info');
            socket = io(SOCKET_URL, {
                auth: { token: token },
                transports: ['websocket', 'polling'],
            });

            socket.on('connect', () => {
                log('‚úÖ Socket connected! ID: ' + socket.id, 'success');
                showStatus('socketStatus', 'Socket connected!', 'success');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('roomSection').classList.remove('hidden');
                document.getElementById('joinSection').classList.remove('hidden');
            });

            socket.on('connect_error', (error) => {
                log('‚ùå Socket error: ' + error.message, 'error');
                showStatus('socketStatus', 'Connection error', 'error');
            });

            socket.on('disconnect', (reason) => {
                log('üëã Disconnected: ' + reason, 'warning');
                showStatus('socketStatus', 'Disconnected', 'error');
            });

            // Game Events
            socket.on('player:joined', (data) => {
                log('üë§ Player joined: ' + JSON.stringify(data), 'success');
                updateLobby();
            });

            socket.on('player:left', (data) => {
                log('üëã Player left: ' + JSON.stringify(data), 'warning');
                updateLobby();
            });

            socket.on('player:ready', (data) => {
                log('‚úÖ Player ready: ' + JSON.stringify(data), 'info');
                updateLobby();
            });

            socket.on('game:started', (data) => {
                log('üéÆ Game started!', 'success');
                document.getElementById('lobbySection').classList.add('hidden');
                document.getElementById('gameSection').classList.remove('hidden');
                showQuestion(data.firstQuestion, data.timeLimit);
            });

            socket.on('question:new', (data) => {
                log('‚ùì New question: ' + data.questionIndex, 'info');
                showQuestion(data.question, data.timeLimit);
            });

            socket.on('question:answered', (data) => {
                log('‚úÖ Answer submitted by player', 'info');
            });

            socket.on('game:ended', (data) => {
                log('üèÅ Game ended!', 'success');
                document.getElementById('gameSection').classList.add('hidden');
                document.getElementById('summarySection').classList.remove('hidden');
                getSummary();
            });
        }

        // Create Room
        async function createRoom() {
            if (!socket || !socket.connected) {
                log('‚ùå Socket not connected', 'error');
                return;
            }

            const numberOfQuestions = parseInt(document.getElementById('numberOfQuestions').value) || 5;
            const maximumPlayers = parseInt(document.getElementById('maximumPlayers').value) || 7;
            const roomCode = 'ROOM' + Date.now();

            document.getElementById('roomCode').value = roomCode;
            isHost = true;

            // Collect all categories
            const categories = {
                quran: {
                    enabled: document.getElementById('catQuran')?.checked || false,
                    difficulty: document.getElementById('diffQuran')?.value || 'medium'
                },
                hadith: {
                    enabled: document.getElementById('catHadith')?.checked || false,
                    difficulty: document.getElementById('diffHadith')?.value || 'medium'
                },
                history: {
                    enabled: document.getElementById('catHistory')?.checked || false,
                    difficulty: document.getElementById('diffHistory')?.value || 'medium'
                },
                fiqh: {
                    enabled: document.getElementById('catFiqh')?.checked || false,
                    difficulty: document.getElementById('diffFiqh')?.value || 'medium'
                },
                seerah: {
                    enabled: document.getElementById('catSeerah')?.checked || false,
                    difficulty: document.getElementById('diffSeerah')?.value || 'medium'
                }
            };

            // Check if at least one category is enabled
            const enabledCategories = Object.values(categories).filter(cat => cat.enabled);
            if (enabledCategories.length === 0) {
                log('‚ùå At least one category must be enabled. Enabling Quran by default.', 'warning');
                categories.quran.enabled = true;
            }

            // Debug: Log categories being sent
            log('üìã Categories: ' + JSON.stringify(categories), 'info');

            try {
                log('üéÆ Creating room via API...', 'info');
                const response = await fetch(`${API_URL}/api/game/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        categories,
                        numberOfQuestions,
                        maximumPlayers
                    })
                });

                const data = await response.json();
                if (data.status === 1) {
                    currentRoom = data.data.roomCode;
                    log('‚úÖ Room created: ' + currentRoom, 'success');
                    showStatus('createRoomStatus', 'Room created: ' + currentRoom, 'success');
                    
                    // Join via socket
                    socket.emit('room:join', {
                        roomCode: currentRoom,
                        playerName: currentUser.email?.split('@')[0] || 'Host',
                        isHost: true
                    }, (response) => {
                        if (response && response.success) {
                            log('‚úÖ Joined room via socket', 'success');
                            document.getElementById('lobbySection').classList.remove('hidden');
                            updateLobby();
                        }
                    });
                } else {
                    log('‚ùå Failed to create room: ' + data.message, 'error');
                    showStatus('createRoomStatus', data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Create room error: ' + error.message, 'error');
            }
        }

        // Join Room
        async function joinRoom() {
            if (!socket || !socket.connected) {
                log('‚ùå Socket not connected', 'error');
                return;
            }

            const roomCode = document.getElementById('joinRoomCode').value.trim().toUpperCase();
            if (!roomCode) {
                showStatus('joinRoomStatus', 'Please enter room code', 'error');
                return;
            }

            try {
                log('üö™ Joining room via API...', 'info');
                const response = await fetch(`${API_URL}/api/game/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomCode: roomCode,
                        username: currentUser.email?.split('@')[0] || 'Player',
                        avatar: ''
                    })
                });

                const data = await response.json();
                if (data.status === 1) {
                    currentRoom = roomCode;
                    isHost = false;
                    log('‚úÖ Joined room via API: ' + currentRoom, 'success');
                    showStatus('joinRoomStatus', 'Joined room: ' + currentRoom, 'success');
                    
                    // Join via socket
                    socket.emit('room:join', {
                        roomCode: currentRoom,
                        playerName: currentUser.email?.split('@')[0] || 'Player',
                        isHost: false
                    }, (response) => {
                        if (response && response.success) {
                            log('‚úÖ Joined room via socket', 'success');
                            document.getElementById('lobbySection').classList.remove('hidden');
                            updateLobby();
                        }
                    });
                } else {
                    log('‚ùå Failed to join room: ' + data.message, 'error');
                    showStatus('joinRoomStatus', data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Join room error: ' + error.message, 'error');
            }
        }

        // Update Lobby
        async function updateLobby() {
            if (!currentRoom) return;

            try {
                const response = await fetch(`${API_URL}/api/game/lobby/${currentRoom}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.status === 1) {
                    const lobby = data.data;
                    document.getElementById('roomInfo').innerHTML = `
                        <p><strong>Room Code:</strong> ${lobby.roomCode}</p>
                        <p><strong>Status:</strong> ${lobby.status}</p>
                        <p><strong>Players:</strong> ${lobby.players?.length || 0} / ${lobby.settings?.maximumPlayers || 0}</p>
                    `;

                    let playersHtml = '';
                    (lobby.players || []).forEach((p, i) => {
                        playersHtml += `
                            <div class="player-item">
                                <span>${i + 1}. ${p.username}</span>
                                <span class="badge ${p.isHost ? 'host' : ''} ${p.isReady ? 'ready' : ''}">
                                    ${p.isHost ? 'üëë Host' : ''} ${p.isReady ? '‚úì Ready' : 'Not Ready'}
                                </span>
                            </div>
                        `;
                    });
                    document.getElementById('playersList').innerHTML = playersHtml;

                    // Enable start button if all ready and user is host
                    const allReady = (lobby.players || []).every(p => p.isReady);
                    const userIsHost = (lobby.players || []).some(p => p.isHost && p.userId?.toString() === currentUser.user_id?.toString());
                    document.getElementById('startBtn').disabled = !allReady || lobby.status !== 'waiting' || !userIsHost;
                }
            } catch (error) {
                log('‚ùå Error updating lobby: ' + error.message, 'error');
            }
        }

        // Toggle Ready
        async function toggleReady() {
            if (!currentRoom) return;

            try {
                const response = await fetch(`${API_URL}/api/game/${currentRoom}/ready`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.status === 1) {
                    log('‚úÖ Ready status toggled', 'success');
                    updateLobby();
                }
            } catch (error) {
                log('‚ùå Error toggling ready: ' + error.message, 'error');
            }
        }

        // Start Game
        async function startGame() {
            if (!currentRoom) return;

            try {
                log('üéÆ Starting game...', 'info');
                const response = await fetch(`${API_URL}/api/game/${currentRoom}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.status === 1) {
                    log('‚úÖ Game started!', 'success');
                } else {
                    log('‚ùå Failed to start: ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Error starting game: ' + error.message, 'error');
            }
        }

        // Show Question
        function showQuestion(question, timeLimit) {
            if (!question) return;

            currentQuestion = question;
            timeLeft = timeLimit || 30;
            document.getElementById('timer').textContent = timeLeft;

            const container = document.getElementById('questionContainer');
            container.innerHTML = `
                <h3>Question ${currentQuestionIndex + 1}</h3>
                <p style="font-size: 1.2em; margin: 15px 0;">${question.question}</p>
                <div id="optionsContainer"></div>
            `;

            const optionsContainer = document.getElementById('optionsContainer');
            (question.options || []).forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                btn.onclick = () => submitAnswer(index);
                optionsContainer.appendChild(btn);
            });

            // Start timer
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitAnswer(-1); // Skip
                }
            }, 1000);
        }

        // Submit Answer
        async function submitAnswer(selectedOption) {
            if (!currentQuestion || !currentRoom) return;

            // Disable buttons
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            if (timerInterval) clearInterval(timerInterval);

            try {
                log(`üìù Submitting answer: ${selectedOption}`, 'info');
                const response = await fetch(`${API_URL}/api/game/submit-answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomCode: currentRoom,
                        questionId: currentQuestion.id || currentQuestion._id,
                        selectedOption: selectedOption,
                        timeTaken: (timeLimit || 30) - timeLeft
                    })
                });

                const data = await response.json();
                if (data.status === 1) {
                    log('‚úÖ Answer submitted successfully', 'success');
                    currentQuestionIndex++;
                } else {
                    log('‚ùå Failed to submit: ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Error submitting answer: ' + error.message, 'error');
            }
        }

        // Get Summary
        async function getSummary() {
            if (!currentRoom) return;

            try {
                const response = await fetch(`${API_URL}/api/game/summary/${currentRoom}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.status === 1) {
                    const summary = data.data;
                    document.getElementById('summaryContent').innerHTML = `
                        <h3>Your Results</h3>
                        <p><strong>Total Score:</strong> ${summary.totalScore}</p>
                        <p><strong>Correct Answers:</strong> ${summary.correctAnswers}</p>
                        <p><strong>Wrong Answers:</strong> ${summary.wrongAnswers || 0}</p>
                        <p><strong>Skipped Answers:</strong> ${summary.skippedAnswers || 0}</p>
                        <p><strong>Accuracy:</strong> ${summary.accuracy}%</p>
                        <p><strong>Rank:</strong> ${summary.rank}</p>
                    `;
                }
            } catch (error) {
                log('‚ùå Error getting summary: ' + error.message, 'error');
            }
        }

        // Get Leaderboard
        async function getLeaderboard() {
            if (!currentRoom) return;

            try {
                const response = await fetch(`${API_URL}/api/game/leaderboard/${currentRoom}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.status === 1) {
                    const leaderboard = data.data.leaderboard || [];
                    let html = '<h3>Leaderboard</h3><ol>';
                    leaderboard.forEach((player, index) => {
                        html += `<li>${player.username} - Score: ${player.score} (Correct: ${player.correctAnswers})</li>`;
                    });
                    html += '</ol>';
                    document.getElementById('leaderboardContent').innerHTML = html;
                }
            } catch (error) {
                log('‚ùå Error getting leaderboard: ' + error.message, 'error');
            }
        }

        // API Testing Functions
        async function testGetLobby() {
            if (!currentRoom) { log('‚ùå No room code', 'error'); return; }
            try {
                const response = await fetch(`${API_URL}/api/game/lobby/${currentRoom}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = 'Error: ' + error.message;
            }
        }

        async function testGetQuestions() {
            if (!currentRoom) { log('‚ùå No room code', 'error'); return; }
            try {
                const response = await fetch(`${API_URL}/api/game/questions/${currentRoom}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = 'Error: ' + error.message;
            }
        }

        async function testGetSummary() {
            if (!currentRoom) { log('‚ùå No room code', 'error'); return; }
            try {
                const response = await fetch(`${API_URL}/api/game/summary/${currentRoom}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = 'Error: ' + error.message;
            }
        }

        async function testGetLeaderboard() {
            if (!currentRoom) { log('‚ùå No room code', 'error'); return; }
            try {
                const response = await fetch(`${API_URL}/api/game/leaderboard/${currentRoom}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = 'Error: ' + error.message;
            }
        }

        async function testGetMyGames() {
            try {
                const response = await fetch(`${API_URL}/api/game/my-games`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = 'Error: ' + error.message;
            }
        }

        async function testGetRoom() {
            if (!currentRoom) { log('‚ùå No room code', 'error'); return; }
            try {
                const response = await fetch(`${API_URL}/api/game/room/${currentRoom}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = 'Error: ' + error.message;
            }
        }

        // Auto-generate room code
        document.getElementById('roomCode').addEventListener('focus', function() {
            if (!this.value) {
                this.value = 'ROOM' + Date.now();
            }
        });

        log('üöÄ Game Test Page Loaded', 'success');
        log('üìã Complete Flow: Login ‚Üí Create/Join ‚Üí Lobby ‚Üí Start ‚Üí Answer ‚Üí Summary', 'info');
    </script>
</body>
</html>
